@using Microsoft.AspNetCore.Identity
@using System.Security.Claims
@using lab1.Data
@inject SignInManager<IdentityUser> SignInManager
@inject UserManager<IdentityUser> UserManager
@inject JournalContext DbContext

@{
    string displayUsername = "username";
    bool hasProfile = false;

    if (SignInManager.IsSignedIn(User))
    {
        var userId = UserManager.GetUserId(User);
        var author = DbContext.Authors.FirstOrDefault(a => a.UserId == userId);

        if (author != null)
        {
            hasProfile = true;
            displayUsername = !string.IsNullOrWhiteSpace(author.Nickname) ? author.Nickname : author.FullName;
        }
    }
}

<style>
    .profile-dropdown-container {
        position: relative;
        display: inline-block;
        margin-left: 10px;
        right: 7px;
    }

    .avatar-btn {
        width: 42px;
        height: 42px;
        border-radius: 50%;
        background: rgba(255, 255, 255, 0.05);
        border: 1px solid rgba(255, 255, 255, 0.15);
        display: flex;
        align-items: center;
        justify-content: center;
        color: #ffffff;
        cursor: pointer;
        transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
        font-weight: 700;
        font-size: 1.1rem;
    }

        .avatar-btn svg {
            width: 20px;
            height: 20px;
            fill: currentColor;
            opacity: 0.8;
        }

        .avatar-btn:hover {
            background: rgba(255, 255, 255, 0.15);
            border-color: rgba(255, 255, 255, 0.3);
            box-shadow: 0 0 15px rgba(255, 255, 255, 0.1);
            transform: scale(1.05);
        }

    .glass-dropdown-menu {
        position: absolute;
        top: -11px;
        left: 87px;
        right: auto;
        width: 220px;
        background: rgba(15, 20, 35, 0.85);
        backdrop-filter: blur(30px) saturate(150%);
        -webkit-backdrop-filter: blur(30px);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 16px;
        padding: 8px;
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.6), inset 0 1px 1px rgba(255, 255, 255, 0.1);
        opacity: 0;
        visibility: hidden;
        transform: translateX(-15px);
        transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1) 0.2s;
        z-index: 1000;
    }

    .profile-dropdown-container:hover .glass-dropdown-menu {
        opacity: 1;
        visibility: visible;
        transform: translateX(0);
        transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1) 0s;
    }

    .dropdown-header {
        padding: 12px 16px 8px 16px;
        border-bottom: none;
        margin-bottom: 0;
    }

    .dropdown-username {
        font-size: 15px;
        font-weight: 600;
        color: #ffffff;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    .dropdown-email-small {
        font-size: 11px;
        color: rgba(255, 255, 255, 0.4);
        margin-top: 4px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    .glass-dropdown-item {
        display: block;
        width: 100%;
        text-align: left;
        padding: 12px 16px;
        color: #ffffff;
        text-decoration: none;
        background: transparent;
        border: none;
        border-radius: 10px;
        font-size: 14px;
        font-weight: 500;
        cursor: pointer;
        transition: background 0.2s;
    }

        .glass-dropdown-item:hover {
            background: rgba(255, 255, 255, 0.1);
            color: #ffffff;
        }

    .item-logout {
        color: #ff453a;
        margin-top: 4px;
    }

        .item-logout:hover {
            background: rgba(255, 69, 58, 0.1);
            color: #ff453a;
        }

    .item-admin {
        color: #00ffc8;
    }

        .item-admin:hover {
            background: rgba(0, 255, 200, 0.1);
            color: #00ffc8;
        }
</style>

<ul class="navbar-nav">
    @if (SignInManager.IsSignedIn(User))
    {
        <li class="nav-item profile-dropdown-container">
            <div class="avatar-btn">
                @if (hasProfile && !string.IsNullOrEmpty(displayUsername))
                {
                    <span>@displayUsername.Substring(0, 1).ToUpper()</span>
                }
                else
                {
                    <svg viewBox="0 0 24 24"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z" /></svg>
                }
            </div>

            <div class="glass-dropdown-menu">
                <div class="dropdown-header">
                    <div class="dropdown-username">@displayUsername</div>
                    @if (!hasProfile)
                    {
                        <div class="dropdown-email-small" style="color: #FFD60A;">Set up your profile</div>
                    }
                </div>

                <a class="glass-dropdown-item" asp-area="" asp-controller="Cabinet" asp-action="Index">Profile</a>


                <form class="form-inline" asp-area="Identity" asp-page="/Account/Logout" asp-route-returnUrl="@Url.Action("Index", "Home", new { area = "" })">
                    <button type="submit" class="glass-dropdown-item item-logout">Sign Out</button>
                </form>
            </div>
        </li>
    }
    else
    {
        <li class="nav-item" style="margin-left: 15px;">
            <a class="nav-link text-white" asp-area="Identity" asp-page="/Account/Login" style="opacity: 0.7;">Sign In</a>
        </li>
    }
</ul>